name: Daily Xero Sync

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      force_full_resync:
        description: 'Force full resync of all journals (backfills tracking data)'
        required: false
        type: boolean
        default: false
      force_full_invoice_resync:
        description: 'Force full resync of all invoices (backfills tracking data)'
        required: false
        type: boolean
        default: false

jobs:
  sync:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Cache virtual environment
      id: cache-venv
      uses: actions/cache@v3
      with:
        path: venv
        key: venv-${{ hashFiles('requirements.txt') }}
    
    - name: Setup virtual environment and install dependencies
      if: steps.cache-venv.outputs.cache-hit != 'true'
      run: |
        sudo apt-get update
        sudo apt-get install -y libpq-dev python3-dev
        python3 -m venv venv
        source venv/bin/activate
        pip install wheel
        pip install -r requirements.txt
    
    - name: Run Xero sync
      env:
        XERO_CLIENT_ID: ${{ secrets.XERO_CLIENT_ID }}
        XERO_CLIENT_SECRET: ${{ secrets.XERO_CLIENT_SECRET }}
        XERO_TENANT_ID: ${{ secrets.XERO_TENANT_ID }}
        XERO_REFRESH_TOKEN: ${{ secrets.XERO_REFRESH_TOKEN }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        DB_USER: ${{ secrets.DB_USER }}
        DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      run: |
        source venv/bin/activate
        ARGS=""
        if [ "${{ github.event.inputs.force_full_resync }}" == "true" ]; then
          ARGS="$ARGS --force-full-resync"
          echo "ðŸ“Š Force full journal resync enabled"
        fi
        if [ "${{ github.event.inputs.force_full_invoice_resync }}" == "true" ]; then
          ARGS="$ARGS --force-full-invoice-resync"
          echo "ðŸ“Š Force full invoice resync enabled"
        fi
        python3 xero_sync.py $ARGS
    
    - name: Sync complete
      if: success()
      run: echo "Xero sync completed successfully"
    
    - name: Sync failed
      if: failure()
      run: echo "Xero sync failed - check logs"
